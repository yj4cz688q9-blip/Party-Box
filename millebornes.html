<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mille Bornes</title>
    <link rel="icon" type="image/png" href="F1CE1FF7-8FC2-440D-8100-49C689144B20.png">
    <link rel="apple-touch-icon" href="F1CE1FF7-8FC2-440D-8100-49C689144B20.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0d0d0d; color: white; font-family: Arial, sans-serif; text-align: center; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 100vh; padding: 20px; }
        .screen.active { display: flex; }
        h1 { font-size: 42px; color: #00e5cc; margin-bottom: 10px; }
        h2 { font-size: 26px; color: #00e5cc; margin-bottom: 20px; }
        .subtitle { font-size: 16px; color: #888; margin-bottom: 40px; }
        .config-box { background-color: #1a1a1a; border-radius: 20px; padding: 20px; width: 100%; max-width: 340px; margin-bottom: 15px; }
        .config-label { font-size: 15px; color: #aaa; margin-bottom: 12px; text-align: left; }
        .counter { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .counter-btn { background-color: #00e5cc; color: #0d0d0d; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 24px; cursor: pointer; font-weight: bold; }
        .counter-value { font-size: 28px; font-weight: bold; min-width: 50px; }
        .start-btn { background-color: #00e5cc; color: #0d0d0d; border: none; border-radius: 20px; padding: 18px 40px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; max-width: 340px; }
        .back-btn { background: none; border: none; color: #888; font-size: 16px; margin-top: 20px; cursor: pointer; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .toggle-label { font-size: 15px; color: #ddd; text-align: left; }
        .toggle { position: relative; width: 50px; height: 28px; cursor: pointer; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; border-radius: 28px; transition: 0.3s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: 0.3s; }
        input:checked + .slider { background-color: #00e5cc; }
        input:checked + .slider:before { transform: translateX(22px); }
        .chance-slider { width: 100%; accent-color: #00e5cc; margin: 10px 0; }
        .chance-value { font-size: 24px; font-weight: bold; color: #00e5cc; }
        .chance-desc { font-size: 13px; color: #888; margin-top: 5px; }
        .km-options { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 5px; }
        .km-btn { background-color: #2a2a2a; border: 2px solid #333; border-radius: 12px; color: white; padding: 8px 16px; font-size: 15px; cursor: pointer; }
        .km-btn.selected { border-color: #00e5cc; color: #00e5cc; font-weight: bold; }
        .player-input { background-color: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 12px 16px; color: white; font-size: 16px; width: 100%; max-width: 340px; margin: 6px 0; }
        .player-input:focus { border-color: #00e5cc; outline: none; }
        .section-title { font-size: 13px; color: #00e5cc; text-transform: uppercase; letter-spacing: 1px; text-align: left; width: 100%; max-width: 340px; margin: 15px 0 5px; }
        .mode-options { display: flex; gap: 10px; justify-content: center; margin-top: 5px; }
        .mode-btn { background-color: #2a2a2a; border: 2px solid #333; border-radius: 12px; color: white; padding: 12px 20px; font-size: 15px; cursor: pointer; flex: 1; max-width: 160px; }
        .mode-btn.selected { border-color: #00e5cc; color: #00e5cc; font-weight: bold; }
        .jeu-header { background-color: #1a1a1a; border-radius: 16px; padding: 12px 20px; width: 100%; max-width: 400px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .jeu-player-name { font-size: 18px; font-weight: bold; color: #00e5cc; }
        .jeu-km { font-size: 16px; color: #aaa; }
        .statuts-box { background-color: #1a1a1a; border-radius: 16px; padding: 12px; width: 100%; max-width: 400px; margin-bottom: 15px; }
        .statuts-title { font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .statuts-row { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .statut-badge { padding: 4px 10px; border-radius: 20px; font-size: 13px; }
        .statut-ok { background-color: #003d2e; color: #00e5cc; }
        .statut-danger { background-color: #3d0000; color: #ff5555; }
        .main-title { font-size: 13px; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .cartes-main { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .carte { background-color: #1a1a1a; border: 2px solid #333; border-radius: 14px; padding: 10px 8px; width: 85px; min-height: 100px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: border-color 0.2s; }
        .carte:active { border-color: #00e5cc; background-color: #0a2a2a; }
        .carte.selected { border-color: #00e5cc; background-color: #0a2a2a; }
        .carte-emoji { font-size: 32px; }
        .carte-nom { font-size: 10px; color: #aaa; line-height: 1.2; }
        .carte-km { font-size: 16px; font-weight: bold; color: #00e5cc; }
        .carte.km { border-color: #1a3a1a; }
        .carte.attaque { border-color: #3a1a1a; }
        .carte.parade { border-color: #1a2a3a; }
        .carte.botte { border-color: #3a2a00; }
        .actions-row { display: flex; gap: 10px; width: 100%; max-width: 400px; margin-bottom: 15px; }
        .action-btn { flex: 1; padding: 14px; border: none; border-radius: 14px; font-size: 15px; font-weight: bold; cursor: pointer; }
        .btn-jouer { background-color: #00e5cc; color: #0d0d0d; }
        .btn-defausser { background-color: #2a2a2a; color: #aaa; border: 2px solid #333; }
        .cible-title { font-size: 14px; color: #888; margin-bottom: 10px; }
        .cibles-row { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .cible-btn { background-color: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; }
        .pioche-info { font-size: 14px; color: #888; margin-bottom: 20px; }
        .pioche-info span { color: #00e5cc; font-weight: bold; }
        .autres-joueurs { width: 100%; max-width: 400px; margin-bottom: 15px; }
        .autre-joueur { background-color: #1a1a1a; border-radius: 12px; padding: 10px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .autre-nom { font-size: 15px; }
        .autre-km { font-size: 15px; color: #00e5cc; font-weight: bold; }
        .autre-statut { font-size: 12px; color: #ff5555; }
        .bot-action { background-color: #1a2a1a; border-radius: 16px; padding: 15px; width: 100%; max-width: 400px; margin-bottom: 15px; font-size: 14px; color: #00e5cc; }
    </style>
</head>
<body>

    <!-- ACCUEIL -->
    <div class="screen active" id="screen-home">
        <h1>üöó Mille Bornes</h1>
        <p class="subtitle">Le jeu de cartes classique !</p>
        <button class="start-btn" onclick="showScreen('screen-config')">‚öôÔ∏è Configuration</button>
        <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Retour √† Party Box</button>
    </div>

    <!-- CONFIG -->
    <div class="screen" id="screen-config">
        <h2>‚öôÔ∏è Configuration</h2>

        <p class="section-title">üéÆ Mode de jeu</p>
        <div class="config-box">
            <div class="mode-options">
                <button class="mode-btn selected" id="mode-local" onclick="selectMode('local')">üë• Local</button>
                <button class="mode-btn" id="mode-solo" onclick="selectMode('solo')">ü§ñ Solo vs Bots</button>
            </div>
        </div>

        <!-- Options solo -->
        <div id="solo-options" style="display:none; width:100%; max-width:340px;">
            <p class="section-title">ü§ñ Bots</p>
            <div class="config-box">
                <p class="config-label">Nombre de bots</p>
                <div class="counter">
                    <button class="counter-btn" onclick="changeBots(-1)">‚àí</button>
                    <span class="counter-value" id="bots-value">1</span>
                    <button class="counter-btn" onclick="changeBots(1)">+</button>
                </div>
            </div>
            <div class="config-box">
                <p class="config-label">Niveau des bots</p>
                <input type="range" class="chance-slider" min="0" max="100" value="50" id="bot-slider" oninput="updateBot(this.value)">
                <div class="chance-value" id="bot-value">50%</div>
                <div class="chance-desc" id="bot-desc">Normal</div>
            </div>
        </div>

        <!-- Options joueurs locaux -->
        <div id="local-options" style="width:100%; max-width:340px;">
            <p class="section-title">üë• Joueurs</p>
            <div class="config-box">
                <p class="config-label">Nombre de joueurs</p>
                <div class="counter">
                    <button class="counter-btn" onclick="changePlayers(-1)">‚àí</button>
                    <span class="counter-value" id="players-value">2</span>
                    <button class="counter-btn" onclick="changePlayers(1)">+</button>
                </div>
            </div>
        </div>

        <p class="section-title">üèÅ Objectif</p>
        <div class="config-box">
            <p class="config-label">Kilom√®tres √† atteindre</p>
            <div class="km-options">
                <button class="km-btn" onclick="selectKm(700, this)">700 km</button>
                <button class="km-btn selected" onclick="selectKm(1000, this)">1000 km</button>
                <button class="km-btn" onclick="selectKm(1500, this)">1500 km</button>
            </div>
        </div>
        <div class="config-box">
            <p class="config-label">Nombre de cartes en main</p>
            <div class="counter">
                <button class="counter-btn" onclick="changeCartes(-1)">‚àí</button>
                <span class="counter-value" id="cartes-value">6</span>
                <button class="counter-btn" onclick="changeCartes(1)">+</button>
            </div>
        </div>

        <p class="section-title">üé≤ Chance</p>
        <div class="config-box">
            <p class="config-label">Niveau de chance</p>
            <input type="range" class="chance-slider" min="0" max="100" value="50" id="chance-slider" oninput="updateChance(this.value)">
            <div class="chance-value" id="chance-value">50%</div>
            <div class="chance-desc" id="chance-desc">√âquilibr√©</div>
        </div>

        <p class="section-title">üèÜ Bottes</p>
        <div class="config-box">
            <div class="toggle-row">
                <span class="toggle-label">Activer les bottes</span>
                <label class="toggle"><input type="checkbox" id="toggle-bottes" checked onchange="toggleBottes()"><span class="slider"></span></label>
            </div>
            <div id="bottes-options">
                <p class="config-label" style="margin-top:10px">Exemplaires de chaque botte</p>
                <div class="counter">
                    <button class="counter-btn" onclick="changeBottes(-1)">‚àí</button>
                    <span class="counter-value" id="bottes-value">1</span>
                    <button class="counter-btn" onclick="changeBottes(1)">+</button>
                </div>
            </div>
        </div>

        <p class="section-title">üìã R√®gles</p>
        <div class="config-box">
            <div class="toggle-row">
                <span class="toggle-label">‚úÖ Points bonus</span>
                <label class="toggle"><input type="checkbox" id="toggle-bonus"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
                <span class="toggle-label">üö¶ Limite de vitesse</span>
                <label class="toggle"><input type="checkbox" id="toggle-limite" checked><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
                <span class="toggle-label">‚ö° Coupe-file</span>
                <label class="toggle"><input type="checkbox" id="toggle-coupefile" checked><span class="slider"></span></label>
            </div>
            <div class="toggle-row" style="margin-bottom:0">
                <span class="toggle-label">üí• Attaques activ√©es</span>
                <label class="toggle"><input type="checkbox" id="toggle-attaques" checked><span class="slider"></span></label>
            </div>
        </div>

        <button class="start-btn" onclick="showPlayerNames()">Suivant ‚û°Ô∏è</button>
        <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Retour</button>
    </div>

    <!-- NOMS JOUEURS -->
    <div class="screen" id="screen-players">
        <h2>‚úèÔ∏è Noms des joueurs</h2>
        <div id="player-inputs"></div>
        <button class="start-btn" onclick="startGame()" style="margin-top:20px">C'est parti ! üöÄ</button>
        <button class="back-btn" onclick="showScreen('screen-config')">‚Üê Retour</button>
    </div>

    <!-- PASSAGE -->
    <div class="screen" id="screen-passage">
        <h2 id="passage-titre"></h2>
        <p style="color:#888; margin-bottom:40px">Passez le t√©l√©phone √† ce joueur !</p>
        <p style="color:#555; font-size:13px; margin-bottom:40px">‚ö†Ô∏è Ne regardez pas la main des autres</p>
        <button class="start-btn" onclick="afficherMain()">üëÄ Voir ma main</button>
    </div>

    <!-- JEU -->
    <div class="screen" id="screen-jeu">
        <div class="jeu-header">
            <span class="jeu-player-name" id="jeu-nom"></span>
            <span class="jeu-km">üèÅ <span id="jeu-km">0</span> / <span id="jeu-objectif">1000</span> km</span>
        </div>
        <div class="statuts-box">
            <div class="statuts-title">Statut</div>
            <div class="statuts-row" id="statuts-row"></div>
        </div>
        <div class="autres-joueurs" id="autres-joueurs"></div>
        <p class="pioche-info">üÉè Pioche : <span id="pioche-count">0</span> cartes restantes</p>
        <p class="main-title">Ta main</p>
        <div class="cartes-main" id="cartes-main"></div>
        <div class="actions-row">
            <button class="action-btn btn-jouer" onclick="jouerCarte()">‚ñ∂Ô∏è Jouer</button>
            <button class="action-btn btn-defausser" onclick="defausserCarte()">üóëÔ∏è D√©fausser</button>
        </div>
        <button class="back-btn" onclick="passerTour()">‚è≠Ô∏è Passer mon tour</button>
    </div>

    <!-- CIBLE -->
    <div class="screen" id="screen-cible">
        <h2>üí• Attaquer qui ?</h2>
        <div class="cibles-row" id="cibles-row"></div>
        <button class="back-btn" onclick="showScreen('screen-jeu')">‚Üê Annuler</button>
    </div>

    <!-- TOUR BOT -->
    <div class="screen" id="screen-bot">
        <h2 id="bot-nom"></h2>
        <div class="bot-action" id="bot-action">ü§ñ Le bot r√©fl√©chit...</div>
        <button class="start-btn" onclick="tourSuivantApresBot()" style="margin-top:30px">Suivant ‚û°Ô∏è</button>
    </div>

    <!-- FIN -->
    <div class="screen" id="screen-fin">
        <h2>üèÜ Fin de partie !</h2>
        <p style="color:#888; margin-bottom:30px" id="fin-gagnant"></p>
        <div id="fin-scores"></div>
        <button class="start-btn" onclick="showScreen('screen-home')" style="margin-top:30px">üè† Accueil</button>
    </div>

    <script>
        let nbPlayers = 2, objectifKm = 1000, nbCartes = 6, chanceLevel = 50, nbBottes = 1;
        let nbBots = 1, botLevel = 50, modeJeu = 'local';
        let reglesBottes = true, reglesBonus = false, reglesLimite = true, reglesCoupefile = true, reglesAttaques = true;
        let joueurs = [], pioche = [], joueurActuel = 0, carteSelectionnee = -1;

        const CARTES_DEF = {
            km25:    { nom: '25 km',          emoji: 'üü¢', type: 'km',     valeur: 25 },
            km50:    { nom: '50 km',          emoji: 'üü°', type: 'km',     valeur: 50 },
            km75:    { nom: '75 km',          emoji: 'üü†', type: 'km',     valeur: 75 },
            km100:   { nom: '100 km',         emoji: 'üîµ', type: 'km',     valeur: 100 },
            km200:   { nom: '200 km',         emoji: 'üî¥', type: 'km',     valeur: 200 },
            accident:   { nom: 'Accident',       emoji: 'üí•', type: 'attaque' },
            panne:      { nom: 'Panne essence',  emoji: '‚õΩ', type: 'attaque' },
            crevaison:  { nom: 'Crevaison',      emoji: 'üîß', type: 'attaque' },
            feu_rouge:  { nom: 'Feu rouge',      emoji: 'üõë', type: 'attaque' },
            limite:     { nom: 'Limite vitesse', emoji: 'üö¶', type: 'attaque' },
            reparation: { nom: 'R√©paration',     emoji: 'üî®', type: 'parade' },
            essence:    { nom: 'Essence',        emoji: 'üõ¢Ô∏è', type: 'parade' },
            roue:       { nom: 'Roue de secours',emoji: 'üî©', type: 'parade' },
            feu_vert:   { nom: 'Feu vert',       emoji: 'üü¢', type: 'parade' },
            fin_limite: { nom: 'Fin de limite',  emoji: '‚úÖ', type: 'parade' },
            as_volant:  { nom: 'As du volant',   emoji: 'üèÖ', type: 'botte' },
            citerne:    { nom: 'Citerne',        emoji: 'üèÖ', type: 'botte' },
            increvable: { nom: 'Increvable',     emoji: 'üèÖ', type: 'botte' },
            prioritaire:{ nom: 'Prioritaire',    emoji: 'üèÖ', type: 'botte' },
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function selectMode(mode) {
            modeJeu = mode;
            document.getElementById('mode-local').classList.toggle('selected', mode === 'local');
            document.getElementById('mode-solo').classList.toggle('selected', mode === 'solo');
            document.getElementById('solo-options').style.display = mode === 'solo' ? 'block' : 'none';
            document.getElementById('local-options').style.display = mode === 'local' ? 'block' : 'none';
        }

        function changePlayers(d) { nbPlayers = Math.min(6, Math.max(2, nbPlayers + d)); document.getElementById('players-value').textContent = nbPlayers; }
        function changeBots(d) { nbBots = Math.min(5, Math.max(1, nbBots + d)); document.getElementById('bots-value').textContent = nbBots; }
        function selectKm(km, btn) { objectifKm = km; document.querySelectorAll('.km-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        function changeCartes(d) { nbCartes = Math.min(10, Math.max(4, nbCartes + d)); document.getElementById('cartes-value').textContent = nbCartes; }
        function changeBottes(d) { nbBottes = Math.min(6, Math.max(1, nbBottes + d)); document.getElementById('bottes-value').textContent = nbBottes; }
        function toggleBottes() { document.getElementById('bottes-options').style.display = document.getElementById('toggle-bottes').checked ? 'block' : 'none'; }

        function updateChance(val) {
            chanceLevel = parseInt(val);
            document.getElementById('chance-value').textContent = val + '%';
            const descs = ['üòà Tr√®s difficile', 'üò§ Difficile', 'üòä √âquilibr√©', 'üçÄ Chanceux', 'üåü Tr√®s chanceux !'];
            document.getElementById('chance-desc').textContent = descs[Math.floor(val / 25)];
        }

        function updateBot(val) {
            botLevel = parseInt(val);
            document.getElementById('bot-value').textContent = val + '%';
            const descs = ['üò¥ Tr√®s facile', 'üôÇ Facile', 'üòê Normal', 'üò§ Difficile', 'üî• Expert'];
            document.getElementById('bot-desc').textContent = descs[Math.floor(val / 25)];
        }

        function showPlayerNames() {
            const c = document.getElementById('player-inputs');
            c.innerHTML = '';
            if (modeJeu === 'solo') {
                const inp = document.createElement('input');
                inp.className = 'player-input';
                inp.placeholder = 'üöó Ton nom';
                inp.id = 'player-1';
                c.appendChild(inp);
            } else {
                for (let i = 1; i <= nbPlayers; i++) {
                    const inp = document.createElement('input');
                    inp.className = 'player-input';
                    inp.placeholder = 'üöó Joueur ' + i;
                    inp.id = 'player-' + i;
                    c.appendChild(inp);
                }
            }
            showScreen('screen-players');
        }

        function creerPioche() {
    const p = [];
    const chance = chanceLevel / 100;
    const mult = nbJoueurs <= 3 ? 1 : nbJoueurs <= 4 ? 1.5 : 2;

    // KM - toujours une bonne base, le 200 varie avec la chance
    const kmPoids = [
        { id: 'km25',  n: Math.round(10 * mult) },
        { id: 'km50',  n: Math.round(10 * mult) },
        { id: 'km75',  n: Math.round(8 * mult) },
        { id: 'km100', n: Math.round(10 * mult) },
        { id: 'km200', n: Math.round((2 + Math.round(chance * 8)) * mult) },
    ];
    kmPoids.forEach(k => { for (let i = 0; i < k.n; i++) p.push(k.id); });

    // Attaques - moins ya de chance, plus ya d'attaques
    if (reglesAttaques) {
        const nbA = Math.round((2 + (1 - chance) * 4) * mult);
        ['accident','panne','crevaison','feu_rouge'].forEach(a => { for (let i = 0; i < nbA; i++) p.push(a); });
        if (reglesLimite) for (let i = 0; i < Math.round(nbA * 0.5); i++) p.push('limite');
    }

    // Parades - toujours suffisantes
    const nbP = Math.round((5 + chance * 3) * mult);
    ['reparation','essence','roue'].forEach(par => { for (let i = 0; i < nbP; i++) p.push(par); });

    // Feu vert - toujours beaucoup
    for (let i = 0; i < Math.round((nbP + 8) * mult); i++) p.push('feu_vert');

    if (reglesLimite) for (let i = 0; i < Math.round(nbP * mult); i++) p.push('fin_limite');
    if (reglesBottes) {
    const nbBottesTotal = Math.max(nbBottes, Math.round(nbBottes + (1 + chance * 3) * mult));
    ['as_volant','citerne','increvable','prioritaire'].forEach(b => { for (let i = 0; i < nbBottesTotal; i++) p.push(b); });
}

    return p.sort(() => Math.random() - 0.5);
}

        function piocher() { return pioche.length > 0 ? pioche.pop() : null; }

        function creerJoueur(nom, estBot = false) {
            return { nom, km: 0, main: [], statuts: { arrete: true, accident: false, panne: false, crevaison: false, limite: false }, bottes: [], estBot };
        }

        function startGame() {
            reglesBottes = document.getElementById('toggle-bottes').checked;
            reglesBonus = document.getElementById('toggle-bonus').checked;
            reglesLimite = document.getElementById('toggle-limite').checked;
            reglesCoupefile = document.getElementById('toggle-coupefile').checked;
            reglesAttaques = document.getElementById('toggle-attaques').checked;

            joueurs = [];
            if (modeJeu === 'solo') {
                const nom = document.getElementById('player-1').value.trim() || 'Joueur';
                joueurs.push(creerJoueur(nom, false));
                for (let i = 1; i <= nbBots; i++) joueurs.push(creerJoueur('ü§ñ Bot ' + i, true));
            } else {
                for (let i = 1; i <= nbPlayers; i++) {
                    const nom = document.getElementById('player-' + i).value.trim() || 'Joueur ' + i;
                    joueurs.push(creerJoueur(nom, false));
                }
            }

            pioche = creerPioche();
            joueurs.forEach(j => { for (let i = 0; i < nbCartes; i++) { const c = piocher(); if (c) j.main.push(c); } });
            joueurActuel = 0;

            if (joueurs[joueurActuel].estBot) jouerBot();
            else afficherPassage();
        }

        function afficherPassage() {
            document.getElementById('passage-titre').textContent = 'üëã ' + joueurs[joueurActuel].nom + ', √† toi !';
            showScreen('screen-passage');
        }

        function afficherMain() {
            carteSelectionnee = -1;
            const j = joueurs[joueurActuel];
            document.getElementById('jeu-nom').textContent = 'üöó ' + j.nom;
            document.getElementById('jeu-km').textContent = j.km;
            document.getElementById('jeu-objectif').textContent = objectifKm;
            document.getElementById('pioche-count').textContent = pioche.length;

            const statutsRow = document.getElementById('statuts-row');
            statutsRow.innerHTML = '';
            if (j.statuts.arrete) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üõë Arr√™t√©</span>';
            else statutsRow.innerHTML += '<span class="statut-badge statut-ok">‚úÖ En route</span>';
            if (j.statuts.accident) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üí• Accident</span>';
            if (j.statuts.panne) statutsRow.innerHTML += '<span class="statut-badge statut-danger">‚õΩ Panne</span>';
            if (j.statuts.crevaison) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üîß Crevaison</span>';
            if (j.statuts.limite) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üö¶ Limit√©</span>';
            j.bottes.forEach(b => statutsRow.innerHTML += '<span class="statut-badge statut-ok">üèÖ ' + CARTES_DEF[b].nom + '</span>');

            const autresDiv = document.getElementById('autres-joueurs');
            autresDiv.innerHTML = '';
            joueurs.forEach((jj, idx) => {
                if (idx === joueurActuel) return;
                let statStr = '';
                if (jj.statuts.accident) statStr += 'üí• ';
                if (jj.statuts.panne) statStr += '‚õΩ ';
                if (jj.statuts.crevaison) statStr += 'üîß ';
                if (jj.statuts.limite) statStr += 'üö¶ ';
                if (jj.statuts.arrete) statStr += 'üõë ';
                autresDiv.innerHTML += `<div class="autre-joueur"><span class="autre-nom">${jj.nom} <span class="autre-statut">${statStr}</span></span><span class="autre-km">${jj.km} km</span></div>`;
            });

            const mainDiv = document.getElementById('cartes-main');
            mainDiv.innerHTML = '';
            j.main.forEach((carteId, idx) => {
                const def = CARTES_DEF[carteId];
                const div = document.createElement('div');
                div.className = 'carte ' + def.type;
                div.innerHTML = `<span class="carte-emoji">${def.emoji}</span>${def.type === 'km' ? '<span class="carte-km">' + def.valeur + '</span>' : ''}<span class="carte-nom">${def.nom}</span>`;
                div.onclick = () => selectionnerCarte(idx);
                mainDiv.appendChild(div);
            });

            showScreen('screen-jeu');
        }

        function selectionnerCarte(idx) {
            carteSelectionnee = idx;
            document.querySelectorAll('.carte').forEach((c, i) => c.classList.toggle('selected', i === idx));
        }

        function jouerCarte() {
            if (carteSelectionnee === -1) { alert('S√©lectionne une carte !'); return; }
            const j = joueurs[joueurActuel];
            const carteId = j.main[carteSelectionnee];
            const def = CARTES_DEF[carteId];
            if (def.type === 'km') jouerKm(carteId, def);
            else if (def.type === 'parade') jouerParade(carteId);
            else if (def.type === 'botte') jouerBotte(carteId);
            else if (def.type === 'attaque') choisirCible(carteId);
        }

        function jouerKm(carteId, def) {
            const j = joueurs[joueurActuel];
            if (j.statuts.arrete) { alert('Tu es arr√™t√© ! Joue un Feu Vert.'); return; }
            if (j.statuts.accident || j.statuts.panne || j.statuts.crevaison) { alert('R√©pare-toi d\'abord !'); return; }
            if (j.statuts.limite && def.valeur > 50) { alert('Limit√© √† 50 km/h !'); return; }
            if (j.km + def.valeur > objectifKm) { alert('Tu d√©passerais l\'objectif !'); return; }
            j.km += def.valeur;
            retirerCarte(); piocherCarte();
            if (j.km >= objectifKm) { finDePartie(); return; }
            finDeTour();
        }

        function jouerParade(carteId) {
            const j = joueurs[joueurActuel];
            const ok =
                (carteId === 'feu_vert' && j.statuts.arrete) ||
                (carteId === 'reparation' && j.statuts.accident) ||
                (carteId === 'essence' && j.statuts.panne) ||
                (carteId === 'roue' && j.statuts.crevaison) ||
                (carteId === 'fin_limite' && j.statuts.limite);
            if (!ok) { alert('Cette parade n\'est pas utile !'); return; }
            if (carteId === 'feu_vert') j.statuts.arrete = false;
            if (carteId === 'reparation') j.statuts.accident = false;
            if (carteId === 'essence') j.statuts.panne = false;
            if (carteId === 'roue') j.statuts.crevaison = false;
            if (carteId === 'fin_limite') j.statuts.limite = false;
            retirerCarte(); piocherCarte(); finDeTour();
        }

        function jouerBotte(carteId) {
            const j = joueurs[joueurActuel];
            j.bottes.push(carteId);
            if (carteId === 'as_volant') j.statuts.accident = false;
            if (carteId === 'citerne') j.statuts.panne = false;
            if (carteId === 'increvable') j.statuts.crevaison = false;
            if (carteId === 'prioritaire') { j.statuts.arrete = false; }
            retirerCarte(); piocherCarte(); finDeTour();
        }

        function choisirCible(carteId) {
            if (!reglesAttaques) { alert('Les attaques sont d√©sactiv√©es !'); return; }
            const ciblesRow = document.getElementById('cibles-row');
            ciblesRow.innerHTML = '';
            joueurs.forEach((jj, idx) => {
                if (idx === joueurActuel) return;
                const btn = document.createElement('button');
                btn.className = 'cible-btn';
                btn.textContent = jj.nom + ' (' + jj.km + ' km)';
                btn.onclick = () => attaquer(idx, carteId);
                ciblesRow.appendChild(btn);
            });
            showScreen('screen-cible');
        }

        function attaquer(cibleIdx, carteId) {
            const cible = joueurs[cibleIdx];
            const botteProtege = { accident: 'as_volant', panne: 'citerne', crevaison: 'increvable', feu_rouge: 'prioritaire' };
            if (botteProtege[carteId] && cible.bottes.includes(botteProtege[carteId])) {
                alert(cible.nom + ' a une botte ! Attaque annul√©e.'); showScreen('screen-jeu'); return;
            }
            if (carteId === 'accident') cible.statuts.accident = true;
            if (carteId === 'panne') cible.statuts.panne = true;
            if (carteId === 'crevaison') cible.statuts.crevaison = true;
            if (carteId === 'feu_rouge') cible.statuts.arrete = true;
            if (carteId === 'limite' && reglesLimite) cible.statuts.limite = true;
            retirerCarte(); piocherCarte();
            showScreen('screen-jeu');
            finDeTour();
        }

        function defausserCarte() {
            if (carteSelectionnee === -1) { alert('S√©lectionne une carte !'); return; }
            retirerCarte(); piocherCarte(); finDeTour();
        }

        function retirerCarte() { joueurs[joueurActuel].main.splice(carteSelectionnee, 1); carteSelectionnee = -1; }
        function piocherCarte() { const c = piocher(); if (c) joueurs[joueurActuel].main.push(c); }
        function passerTour() { finDeTour(); }

        function finDeTour() {
            joueurActuel = (joueurActuel + 1) % joueurs.length;
            if (joueurs[joueurActuel].estBot) jouerBot();
            else afficherPassage();
        }

        // IA DU BOT
        function jouerBot() {
            const j = joueurs[joueurActuel];
            const niveau = botLevel / 100;
            let action = '';

            // 1. Jouer une botte si on en a
            const botte = j.main.find(c => CARTES_DEF[c].type === 'botte');
            if (botte && (niveau > 0.3 || Math.random() < 0.5)) {
                j.bottes.push(botte);
                if (botte === 'as_volant') j.statuts.accident = false;
                if (botte === 'citerne') j.statuts.panne = false;
                if (botte === 'increvable') j.statuts.crevaison = false;
                if (botte === 'prioritaire') j.statuts.arrete = false;
                j.main.splice(j.main.indexOf(botte), 1);
                const c = piocher(); if (c) j.main.push(c);
                action = 'üèÖ ' + j.nom + ' joue la botte ' + CARTES_DEF[botte].nom + ' !';
            }
            // 2. Se soigner si probl√®me
            else if (j.statuts.arrete && !j.statuts.accident && !j.statuts.panne && !j.statuts.crevaison) {
                const fv = j.main.find(c => c === 'feu_vert');
                if (fv) { j.statuts.arrete = false; j.main.splice(j.main.indexOf(fv), 1); const c = piocher(); if (c) j.main.push(c); action = 'üü¢ ' + j.nom + ' joue Feu Vert !'; }
                else { defausserBotInutile(j); action = 'üóëÔ∏è ' + j.nom + ' d√©fausse une carte inutile'; }

            }
            else if (j.statuts.accident) {
                const rep = j.main.find(c => c === 'reparation');
                if (rep) { j.statuts.accident = false; j.main.splice(j.main.indexOf(rep), 1); const c = piocher(); if (c) j.main.push(c); action = 'üî® ' + j.nom + ' se r√©pare !'; }
                else { const c = piocher(); if (c) j.main.push(c); action = '‚è≠Ô∏è ' + j.nom + ' passe (pas de r√©paration)'; }
            }
            else if (j.statuts.panne) {
                const ess = j.main.find(c => c === 'essence');
                if (ess) { j.statuts.panne = false; j.main.splice(j.main.indexOf(ess), 1); const c = piocher(); if (c) j.main.push(c); action = 'üõ¢Ô∏è ' + j.nom + ' fait le plein !'; }
                else { const c = piocher(); if (c) j.main.push(c); action = '‚è≠Ô∏è ' + j.nom + ' passe (pas d\'essence)'; }
            }
            else if (j.statuts.crevaison) {
                const roue = j.main.find(c => c === 'roue');
                if (roue) { j.statuts.crevaison = false; j.main.splice(j.main.indexOf(roue), 1); const c = piocher(); if (c) j.main.push(c); action = 'üî© ' + j.nom + ' change la roue !'; }
                else { const c = piocher(); if (c) j.main.push(c); action = '‚è≠Ô∏è ' + j.nom + ' passe (pas de roue)'; }
            }
            // 3. Attaquer si niveau √©lev√©
            else if (reglesAttaques && niveau > 0.4 && Math.random() < niveau * 0.6) {
                const attaques = j.main.filter(c => CARTES_DEF[c].type === 'attaque');
                if (attaques.length > 0) {
                    const attaque = attaques[Math.floor(Math.random() * attaques.length)];
                    const cibles = joueurs.filter((jj, idx) => idx !== joueurActuel);
                    if (cibles.length > 0) {
                        const cible = cibles.reduce((a, b) => a.km > b.km ? a : b);
                        const botteProtege = { accident: 'as_volant', panne: 'citerne', crevaison: 'increvable', feu_rouge: 'prioritaire' };
                        if (!botteProtege[attaque] || !cible.bottes.includes(botteProtege[attaque])) {
                            if (attaque === 'accident') cible.statuts.accident = true;
                            if (attaque === 'panne') cible.statuts.panne = true;
                            if (attaque === 'crevaison') cible.statuts.crevaison = true;
                            if (attaque === 'feu_rouge') cible.statuts.arrete = true;
                            if (attaque === 'limite' && reglesLimite) cible.statuts.limite = true;
                            j.main.splice(j.main.indexOf(attaque), 1);
                            const c = piocher(); if (c) j.main.push(c);
                            action = CARTES_DEF[attaque].emoji + ' ' + j.nom + ' attaque ' + cible.nom + ' avec ' + CARTES_DEF[attaque].nom + ' !';
                        } else { action = '‚è≠Ô∏è ' + j.nom + ' passe (botte prot√®ge la cible)'; const c = piocher(); if (c) j.main.push(c); }
                    }
                } else {
                    // Jouer km
                    jouerKmBot(j);
                    action = 'üöó ' + j.nom + ' avance !';
                }
            }
            // 4. Avancer
            else {
                const avant = jouerKmBot(j);
                if (avant) action = 'üöó ' + j.nom + ' avance de ' + avant + ' km ! (total: ' + j.km + ' km)';
                else { const c = piocher(); if (c) j.main.push(c); action = '‚è≠Ô∏è ' + j.nom + ' passe son tour'; }
            }

            document.getElementById('bot-nom').textContent = 'ü§ñ Tour de ' + j.nom;
            document.getElementById('bot-action').textContent = action;
            showScreen('screen-bot');

            if (j.km >= objectifKm) { setTimeout(finDePartie, 1000); }
        }
function defausserBotInutile(j) {
    const prioriteDefausse = ['limite', 'fin_limite', 'accident', 'panne', 'crevaison', 'feu_rouge'];
    for (const cible of prioriteDefausse) {
        const idx = j.main.indexOf(cible);
        if (idx !== -1) {
            j.main.splice(idx, 1);
            const c = piocher(); if (c) j.main.push(c);
            return;
        }
    }
    j.main.splice(0, 1);
    const c = piocher(); if (c) j.main.push(c);
}

        function jouerKmBot(j) {
            const kmCartes = j.main.filter(c => CARTES_DEF[c].type === 'km')
                .filter(c => {
                    const def = CARTES_DEF[c];
                    if (j.statuts.limite && def.valeur > 50) return false;
                    if (j.km + def.valeur > objectifKm) return false;
                    return true;
                })
                .sort((a, b) => CARTES_DEF[b].valeur - CARTES_DEF[a].valeur);
            if (kmCartes.length > 0) {
                const meilleure = kmCartes[0];
                const valeur = CARTES_DEF[meilleure].valeur;
                j.km += valeur;
                j.main.splice(j.main.indexOf(meilleure), 1);
                const c = piocher(); if (c) j.main.push(c);
                return valeur;
            }
            return null;
        }

        function tourSuivantApresBot() {
            joueurActuel = (joueurActuel + 1) % joueurs.length;
            if (joueurs[joueurActuel].estBot) jouerBot();
            else afficherPassage();
        }

        function finDePartie() {
            const gagnant = joueurs.reduce((a, b) => a.km > b.km ? a : b);
            document.getElementById('fin-gagnant').textContent = 'ü•á ' + gagnant.nom + ' a gagn√© avec ' + gagnant.km + ' km !';
            const scoresDiv = document.getElementById('fin-scores');
            scoresDiv.innerHTML = '';
            [...joueurs].sort((a, b) => b.km - a.km).forEach((j, i) => {
                scoresDiv.innerHTML += `<div class="autre-joueur"><span class="autre-nom">${i+1}. ${j.nom}</span><span class="autre-km">${j.km} km</span></div>`;
            });
            showScreen('screen-fin');
        }
    </script>
</body>
</html>
