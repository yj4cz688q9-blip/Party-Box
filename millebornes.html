<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mille Bornes</title>
    <link rel="icon" type="image/png" href="F1CE1FF7-8FC2-440D-8100-49C689144B20.png">
    <link rel="apple-touch-icon" href="F1CE1FF7-8FC2-440D-8100-49C689144B20.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0d0d0d; color: white; font-family: Arial, sans-serif; text-align: center; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 100vh; padding: 20px; }
        .screen.active { display: flex; }
        h1 { font-size: 42px; color: #00e5cc; margin-bottom: 10px; }
        h2 { font-size: 26px; color: #00e5cc; margin-bottom: 20px; }
        .subtitle { font-size: 16px; color: #888; margin-bottom: 40px; }
        .config-box { background-color: #1a1a1a; border-radius: 20px; padding: 20px; width: 100%; max-width: 340px; margin-bottom: 15px; }
        .config-label { font-size: 15px; color: #aaa; margin-bottom: 12px; text-align: left; }
        .counter { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .counter-btn { background-color: #00e5cc; color: #0d0d0d; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 24px; cursor: pointer; font-weight: bold; }
        .counter-value { font-size: 28px; font-weight: bold; min-width: 50px; }
        .start-btn { background-color: #00e5cc; color: #0d0d0d; border: none; border-radius: 20px; padding: 18px 40px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; max-width: 340px; }
        .back-btn { background: none; border: none; color: #888; font-size: 16px; margin-top: 20px; cursor: pointer; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .toggle-label { font-size: 15px; color: #ddd; text-align: left; }
        .toggle { position: relative; width: 50px; height: 28px; cursor: pointer; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; border-radius: 28px; transition: 0.3s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: 0.3s; }
        input:checked + .slider { background-color: #00e5cc; }
        input:checked + .slider:before { transform: translateX(22px); }
        .chance-slider { width: 100%; accent-color: #00e5cc; margin: 10px 0; }
        .chance-value { font-size: 24px; font-weight: bold; color: #00e5cc; }
        .chance-desc { font-size: 13px; color: #888; margin-top: 5px; }
        .km-options { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 5px; }
        .km-btn { background-color: #2a2a2a; border: 2px solid #333; border-radius: 12px; color: white; padding: 8px 16px; font-size: 15px; cursor: pointer; }
        .km-btn.selected { border-color: #00e5cc; color: #00e5cc; font-weight: bold; }
        .player-input { background-color: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 12px 16px; color: white; font-size: 16px; width: 100%; max-width: 340px; margin: 6px 0; }
        .player-input:focus { border-color: #00e5cc; outline: none; }
        .section-title { font-size: 13px; color: #00e5cc; text-transform: uppercase; letter-spacing: 1px; text-align: left; width: 100%; max-width: 340px; margin: 15px 0 5px; }

        /* JEU */
        .jeu-header { background-color: #1a1a1a; border-radius: 16px; padding: 12px 20px; width: 100%; max-width: 400px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .jeu-player-name { font-size: 18px; font-weight: bold; color: #00e5cc; }
        .jeu-km { font-size: 16px; color: #aaa; }
        .jeu-km span { color: white; font-weight: bold; }

        .statuts-box { background-color: #1a1a1a; border-radius: 16px; padding: 12px; width: 100%; max-width: 400px; margin-bottom: 15px; }
        .statuts-title { font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .statuts-row { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .statut-badge { padding: 4px 10px; border-radius: 20px; font-size: 13px; }
        .statut-ok { background-color: #003d2e; color: #00e5cc; }
        .statut-danger { background-color: #3d0000; color: #ff5555; }
        .statut-neutre { background-color: #2a2a2a; color: #888; }

        .main-title { font-size: 13px; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .cartes-main { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .carte {
            background-color: #1a1a1a;
            border: 2px solid #333;
            border-radius: 14px;
            padding: 10px 8px;
            width: 80px;
            min-height: 90px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: border-color 0.2s;
        }
        .carte:active { border-color: #00e5cc; background-color: #0a2a2a; }
        .carte.selected { border-color: #00e5cc; background-color: #0a2a2a; }
        .carte-emoji { font-size: 24px; }
        .carte-nom { font-size: 10px; color: #aaa; line-height: 1.2; }
        .carte-km { font-size: 16px; font-weight: bold; color: #00e5cc; }

        .carte.km { border-color: #1a3a1a; }
        .carte.attaque { border-color: #3a1a1a; }
        .carte.parade { border-color: #1a2a3a; }
        .carte.botte { border-color: #3a2a00; }

        .actions-row { display: flex; gap: 10px; width: 100%; max-width: 400px; margin-bottom: 15px; }
        .action-btn { flex: 1; padding: 14px; border: none; border-radius: 14px; font-size: 15px; font-weight: bold; cursor: pointer; }
        .btn-jouer { background-color: #00e5cc; color: #0d0d0d; }
        .btn-defausser { background-color: #2a2a2a; color: #aaa; border: 2px solid #333; }
        .btn-passer { background-color: #1a1a1a; color: #888; border: 2px solid #222; }

        .cible-title { font-size: 14px; color: #888; margin-bottom: 10px; }
        .cibles-row { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .cible-btn { background-color: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; }
        .cible-btn:active { border-color: #ff5555; }

        .pioche-info { font-size: 14px; color: #888; margin-bottom: 20px; }
        .pioche-info span { color: #00e5cc; font-weight: bold; }

        /* SCORES AUTRES JOUEURS */
        .autres-joueurs { width: 100%; max-width: 400px; margin-bottom: 15px; }
        .autre-joueur { background-color: #1a1a1a; border-radius: 12px; padding: 10px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .autre-nom { font-size: 15px; }
        .autre-km { font-size: 15px; color: #00e5cc; font-weight: bold; }
        .autre-statut { font-size: 12px; color: #ff5555; }
    </style>
</head>
<body>

    <!-- ACCUEIL -->
    <div class="screen active" id="screen-home">
        <h1>üöó Mille Bornes</h1>
        <p class="subtitle">Le jeu de cartes classique !</p>
        <button class="start-btn" onclick="showScreen('screen-config')">‚öôÔ∏è Configuration</button>
        <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Retour √† Party Box</button>
    </div>

    <!-- CONFIG -->
    <div class="screen" id="screen-config">
        <h2>‚öôÔ∏è Configuration</h2>
        <p class="section-title">üë• Joueurs</p>
        <div class="config-box">
            <p class="config-label">Nombre de joueurs</p>
            <div class="counter">
                <button class="counter-btn" onclick="changePlayers(-1)">‚àí</button>
                <span class="counter-value" id="players-value">2</span>
                <button class="counter-btn" onclick="changePlayers(1)">+</button>
            </div>
        </div>
        <p class="section-title">üèÅ Objectif</p>
        <div class="config-box">
            <p class="config-label">Kilom√®tres √† atteindre</p>
            <div class="km-options">
                <button class="km-btn" onclick="selectKm(700, this)">700 km</button>
                <button class="km-btn selected" onclick="selectKm(1000, this)">1000 km</button>
                <button class="km-btn" onclick="selectKm(1500, this)">1500 km</button>
            </div>
        </div>
        <div class="config-box">
            <p class="config-label">Nombre de cartes en main</p>
            <div class="counter">
                <button class="counter-btn" onclick="changeCartes(-1)">‚àí</button>
                <span class="counter-value" id="cartes-value">6</span>
                <button class="counter-btn" onclick="changeCartes(1)">+</button>
            </div>
        </div>
        <p class="section-title">üé≤ Chance</p>
        <div class="config-box">
            <p class="config-label">Niveau de chance</p>
            <input type="range" class="chance-slider" min="0" max="100" value="50" id="chance-slider" oninput="updateChance(this.value)">
            <div class="chance-value" id="chance-value">50%</div>
            <div class="chance-desc" id="chance-desc">√âquilibr√©</div>
        </div>
        <p class="section-title">üèÜ Bottes</p>
        <div class="config-box">
            <div class="toggle-row">
                <span class="toggle-label">Activer les bottes</span>
                <label class="toggle"><input type="checkbox" id="toggle-bottes" checked onchange="toggleBottes()"><span class="slider"></span></label>
            </div>
            <div id="bottes-options">
                <p class="config-label" style="margin-top:10px">Exemplaires de chaque botte</p>
                <div class="counter">
                    <button class="counter-btn" onclick="changeBottes(-1)">‚àí</button>
                    <span class="counter-value" id="bottes-value">1</span>
                    <button class="counter-btn" onclick="changeBottes(1)">+</button>
                </div>
            </div>
        </div>
        <p class="section-title">üìã R√®gles</p>
        <div class="config-box">
            <div class="toggle-row">
                <span class="toggle-label">‚úÖ Points bonus</span>
                <label class="toggle"><input type="checkbox" id="toggle-bonus"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
                <span class="toggle-label">üö¶ Limite de vitesse</span>
                <label class="toggle"><input type="checkbox" id="toggle-limite" checked><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
                <span class="toggle-label">‚ö° Coupe-file</span>
                <label class="toggle"><input type="checkbox" id="toggle-coupefile" checked><span class="slider"></span></label>
            </div>
            <div class="toggle-row" style="margin-bottom:0">
                <span class="toggle-label">üí• Attaques activ√©es</span>
                <label class="toggle"><input type="checkbox" id="toggle-attaques" checked><span class="slider"></span></label>
            </div>
        </div>
        <button class="start-btn" onclick="showPlayerNames()">Suivant ‚û°Ô∏è</button>
        <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Retour</button>
    </div>

    <!-- NOMS JOUEURS -->
    <div class="screen" id="screen-players">
        <h2>‚úèÔ∏è Noms des joueurs</h2>
        <div id="player-inputs"></div>
        <button class="start-btn" onclick="startGame()" style="margin-top:20px">C'est parti ! üöÄ</button>
        <button class="back-btn" onclick="showScreen('screen-config')">‚Üê Retour</button>
    </div>

    <!-- √âCRAN PASSAGE -->
    <div class="screen" id="screen-passage">
        <h2 id="passage-titre"></h2>
        <p style="color:#888; margin-bottom:40px">Passez le t√©l√©phone √† ce joueur !</p>
        <p style="color:#555; font-size:13px; margin-bottom:40px">‚ö†Ô∏è Ne regardez pas la main des autres</p>
        <button class="start-btn" onclick="afficherMain()">üëÄ Voir ma main</button>
    </div>

    <!-- √âCRAN JEU -->
    <div class="screen" id="screen-jeu">
        <div class="jeu-header">
            <span class="jeu-player-name" id="jeu-nom"></span>
            <span class="jeu-km">üèÅ <span id="jeu-km">0</span> / <span id="jeu-objectif">1000</span> km</span>
        </div>

        <div class="statuts-box">
            <div class="statuts-title">Statut</div>
            <div class="statuts-row" id="statuts-row"></div>
        </div>

        <div class="autres-joueurs" id="autres-joueurs"></div>

        <p class="pioche-info">üÉè Pioche : <span id="pioche-count">0</span> cartes restantes</p>

        <p class="main-title">Ta main</p>
        <div class="cartes-main" id="cartes-main"></div>

        <div class="actions-row">
            <button class="action-btn btn-jouer" onclick="jouerCarte()">‚ñ∂Ô∏è Jouer</button>
            <button class="action-btn btn-defausser" onclick="defausserCarte()">üóëÔ∏è D√©fausser</button>
        </div>

        <button class="back-btn" onclick="passerTour()">‚è≠Ô∏è Passer mon tour</button>
    </div>

    <!-- CHOISIR CIBLE (pour attaques) -->
    <div class="screen" id="screen-cible">
        <h2>üí• Attaquer qui ?</h2>
        <div class="cibles-row" id="cibles-row"></div>
        <button class="back-btn" onclick="showScreen('screen-jeu')">‚Üê Annuler</button>
    </div>

    <!-- FIN DE PARTIE -->
    <div class="screen" id="screen-fin">
        <h2>üèÜ Fin de partie !</h2>
        <p style="color:#888; margin-bottom:30px" id="fin-gagnant"></p>
        <div id="fin-scores"></div>
        <button class="start-btn" onclick="showScreen('screen-home')" style="margin-top:30px">üè† Accueil</button>
    </div>

    <script>
        // CONFIG
        let nbPlayers = 2, objectifKm = 1000, nbCartes = 6, chanceLevel = 50, nbBottes = 1;
        let reglesBottes = true, reglesBonus = false, reglesLimite = true, reglesCoupefile = true, reglesAttaques = true;

        // √âTAT JEU
        let joueurs = [], pioche = [], joueurActuel = 0, carteSelectionnee = -1;

        // TYPES DE CARTES
        const CARTES_DEF = {
            km25:   { nom: '25 km',           emoji: 'üü¢', type: 'km',     valeur: 25 },
            km50:   { nom: '50 km',           emoji: 'üü°', type: 'km',     valeur: 50 },
            km75:   { nom: '75 km',           emoji: 'üü†', type: 'km',     valeur: 75 },
            km100:  { nom: '100 km',          emoji: 'üîµ', type: 'km',     valeur: 100 },
            km200:  { nom: '200 km',          emoji: 'üî¥', type: 'km',     valeur: 200 },
            accident:   { nom: 'Accident',        emoji: 'üí•', type: 'attaque', contre: 'reparation' },
            panne:      { nom: 'Panne essence',   emoji: '‚õΩ', type: 'attaque', contre: 'essence' },
            crevaison:  { nom: 'Crevaison',       emoji: 'üîß', type: 'attaque', contre: 'roue' },
            feu_rouge:  { nom: 'Feu rouge',       emoji: 'üî¥', type: 'attaque', contre: 'feu_vert' },
            limite:     { nom: 'Limite vitesse',  emoji: 'üö¶', type: 'attaque', contre: 'fin_limite' },
            reparation: { nom: 'R√©paration',      emoji: 'üî®', type: 'parade', contre: 'accident' },
            essence:    { nom: 'Essence',         emoji: 'üõ¢Ô∏è', type: 'parade', contre: 'panne' },
            roue:       { nom: 'Roue de secours', emoji: 'üî©', type: 'parade', contre: 'crevaison' },
            feu_vert:   { nom: 'Feu vert',        emoji: 'üü¢', type: 'parade', contre: 'feu_rouge' },
            fin_limite: { nom: 'Fin de limite',   emoji: '‚úÖ', type: 'parade', contre: 'limite' },
            as_volant:  { nom: 'As du volant',    emoji: 'üèÖ', type: 'botte', protege: 'accident' },
            citerne:    { nom: 'Citerne',         emoji: 'üèÖ', type: 'botte', protege: 'panne' },
            increvable: { nom: 'Increvable',      emoji: 'üèÖ', type: 'botte', protege: 'crevaison' },
            prioritaire:{ nom: 'Prioritaire',     emoji: 'üèÖ', type: 'botte', protege: 'feu_rouge' },
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function changePlayers(d) { nbPlayers = Math.min(6, Math.max(2, nbPlayers + d)); document.getElementById('players-value').textContent = nbPlayers; }
        function selectKm(km, btn) { objectifKm = km; document.querySelectorAll('.km-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        function changeCartes(d) { nbCartes = Math.min(10, Math.max(4, nbCartes + d)); document.getElementById('cartes-value').textContent = nbCartes; }
        function changeBottes(d) { nbBottes = Math.min(6, Math.max(1, nbBottes + d)); document.getElementById('bottes-value').textContent = nbBottes; }
        function toggleBottes() { document.getElementById('bottes-options').style.display = document.getElementById('toggle-bottes').checked ? 'block' : 'none'; }
        function updateChance(val) {
            chanceLevel = parseInt(val);
            document.getElementById('chance-value').textContent = val + '%';
            const descs = ['üòà Tr√®s difficile', 'üò§ Difficile', 'üòä √âquilibr√©', 'üçÄ Chanceux', 'üåü Tr√®s chanceux !'];
            document.getElementById('chance-desc').textContent = descs[Math.floor(val / 25)];
        }

        function showPlayerNames() {
            const c = document.getElementById('player-inputs');
            c.innerHTML = '';
            for (let i = 1; i <= nbPlayers; i++) {
                const inp = document.createElement('input');
                inp.className = 'player-input';
                inp.placeholder = 'üöó Joueur ' + i;
                inp.id = 'player-' + i;
                c.appendChild(inp);
            }
            showScreen('screen-players');
        }

        function creerPioche() {
            const p = [];
            const chance = chanceLevel / 100;

            // KM
            const kmPoids = [
                { id: 'km25',  base: 10 },
                { id: 'km50',  base: 10 },
                { id: 'km75',  base: 10 },
                { id: 'km100', base: 12 },
                { id: 'km200', base: 4 + Math.round(chance * 8) },
            ];
            kmPoids.forEach(k => { for (let i = 0; i < k.base; i++) p.push(k.id); });

            // ATTAQUES
            if (reglesAttaques) {
                const nbAttaques = Math.round(5 - chance * 3);
                ['accident','panne','crevaison','feu_rouge'].forEach(a => {
                    for (let i = 0; i < Math.max(1, nbAttaques); i++) p.push(a);
                });
                if (reglesLimite) for (let i = 0; i < Math.max(1, nbAttaques); i++) p.push('limite');
            }

            // PARADES
            const nbParades = Math.round(4 + chance * 4);
            ['reparation','essence','roue'].forEach(par => {
    for (let i = 0; i < nbParades; i++) p.push(par);
});
for (let i = 0; i < nbParades + 5; i++) p.push('feu_vert');

            if (reglesLimite) for (let i = 0; i < nbParades; i++) p.push('fin_limite');

            // BOTTES
            if (reglesBottes) {
                ['as_volant','citerne','increvable','prioritaire'].forEach(b => {
                    for (let i = 0; i < nbBottes; i++) p.push(b);
                });
            }

            return p.sort(() => Math.random() - 0.5);
        }

        function piocher() {
            if (pioche.length === 0) return null;
            return pioche.pop();
        }

        function startGame() {
            reglesBottes = document.getElementById('toggle-bottes').checked;
            reglesBonus = document.getElementById('toggle-bonus').checked;
            reglesLimite = document.getElementById('toggle-limite').checked;
            reglesCoupefile = document.getElementById('toggle-coupefile').checked;
            reglesAttaques = document.getElementById('toggle-attaques').checked;

            joueurs = [];
            for (let i = 1; i <= nbPlayers; i++) {
                const nom = document.getElementById('player-' + i).value.trim() || 'Joueur ' + i;
                joueurs.push({ nom, km: 0, main: [], statuts: { arrete: true, accident: false, panne: false, crevaison: false, limite: false }, bottes: [] });
            }

            pioche = creerPioche();

            // Distribuer les cartes
            joueurs.forEach(j => {
                for (let i = 0; i < nbCartes; i++) {
                    const c = piocher();
                    if (c) j.main.push(c);
                }
            });

            joueurActuel = 0;
            afficherPassage();
        }

        function afficherPassage() {
            document.getElementById('passage-titre').textContent = 'üëã ' + joueurs[joueurActuel].nom + ', √† toi !';
            showScreen('screen-passage');
        }

        function afficherMain() {
            carteSelectionnee = -1;
            const j = joueurs[joueurActuel];

            document.getElementById('jeu-nom').textContent = 'üöó ' + j.nom;
            document.getElementById('jeu-km').textContent = j.km;
            document.getElementById('jeu-objectif').textContent = objectifKm;
            document.getElementById('pioche-count').textContent = pioche.length;

            // Statuts
            const statutsRow = document.getElementById('statuts-row');
            statutsRow.innerHTML = '';
            if (j.statuts.arrete) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üõë Arr√™t√©</span>';
            if (!j.statuts.arrete) statutsRow.innerHTML += '<span class="statut-badge statut-ok">‚úÖ En route</span>';
            if (j.statuts.accident) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üí• Accident</span>';
            if (j.statuts.panne) statutsRow.innerHTML += '<span class="statut-badge statut-danger">‚õΩ Panne</span>';
            if (j.statuts.crevaison) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üîß Crevaison</span>';
            if (j.statuts.limite) statutsRow.innerHTML += '<span class="statut-badge statut-danger">üö¶ Limit√©</span>';
            j.bottes.forEach(b => statutsRow.innerHTML += '<span class="statut-badge statut-ok">üèÖ ' + CARTES_DEF[b].nom + '</span>');

            // Autres joueurs
            const autresDiv = document.getElementById('autres-joueurs');
            autresDiv.innerHTML = '';
            joueurs.forEach((jj, idx) => {
                if (idx === joueurActuel) return;
                let statStr = '';
                if (jj.statuts.accident) statStr += 'üí• ';
                if (jj.statuts.panne) statStr += '‚õΩ ';
                if (jj.statuts.crevaison) statStr += 'üîß ';
                if (jj.statuts.limite) statStr += 'üö¶ ';
                if (jj.statuts.arrete) statStr += 'üõë ';
                autresDiv.innerHTML += `<div class="autre-joueur"><span class="autre-nom">${jj.nom} <span class="autre-statut">${statStr}</span></span><span class="autre-km">${jj.km} km</span></div>`;
            });

            // Main
            const mainDiv = document.getElementById('cartes-main');
            mainDiv.innerHTML = '';
            j.main.forEach((carteId, idx) => {
                const def = CARTES_DEF[carteId];
                const div = document.createElement('div');
                div.className = 'carte ' + def.type;
                div.innerHTML = `<span class="carte-emoji">${def.emoji}</span>${def.type === 'km' ? '<span class="carte-km">' + def.valeur + '</span>' : ''}<span class="carte-nom">${def.nom}</span>`;
                div.onclick = () => selectionnerCarte(idx);
                mainDiv.appendChild(div);
            });

            showScreen('screen-jeu');
        }

        function selectionnerCarte(idx) {
            carteSelectionnee = idx;
            document.querySelectorAll('.carte').forEach((c, i) => {
                c.classList.toggle('selected', i === idx);
            });
        }

        function jouerCarte() {
            if (carteSelectionnee === -1) { alert('S√©lectionne une carte d\'abord !'); return; }
            const j = joueurs[joueurActuel];
            const carteId = j.main[carteSelectionnee];
            const def = CARTES_DEF[carteId];

            if (def.type === 'km') jouerKm(carteId, def);
            else if (def.type === 'parade') jouerParade(carteId, def);
            else if (def.type === 'botte') jouerBotte(carteId);
            else if (def.type === 'attaque') choisirCible(carteId, def);
        }

        function jouerKm(carteId, def) {
            const j = joueurs[joueurActuel];
            if (j.statuts.arrete) { alert('Tu es arr√™t√© ! Joue un Feu Vert d\'abord.'); return; }
            if (j.statuts.accident || j.statuts.panne || j.statuts.crevaison) { alert('Tu as un probl√®me ! R√©pare-toi d\'abord.'); return; }
            if (j.statuts.limite && def.valeur > 50) { alert('Tu es limit√© √† 50 km/h ! Tu ne peux jouer que des 25 ou 50 km.'); return; }
            if (j.km + def.valeur > objectifKm) { alert('Tu d√©passerais l\'objectif ! Joue une carte plus petite.'); return; }

            j.km += def.valeur;
            retirerCarte();
            piocherCarte();
            if (j.km >= objectifKm) { finDePartie(); return; }
            finDeTour();
        }

        function jouerParade(carteId, def) {
            const j = joueurs[joueurActuel];
            if (carteId === 'feu_vert' && j.statuts.arrete) { j.statuts.arrete = false; retirerCarte(); piocherCarte(); finDeTour(); return; }
            if (carteId === 'reparation' && j.statuts.accident) { j.statuts.accident = false; retirerCarte(); piocherCarte(); finDeTour(); return; }
            if (carteId === 'essence' && j.statuts.panne) { j.statuts.panne = false; retirerCarte(); piocherCarte(); finDeTour(); return; }
            if (carteId === 'roue' && j.statuts.crevaison) { j.statuts.crevaison = false; retirerCarte(); piocherCarte(); finDeTour(); return; }
            if (carteId === 'fin_limite' && j.statuts.limite) { j.statuts.limite = false; retirerCarte(); piocherCarte(); finDeTour(); return; }
            alert('Cette parade n\'est pas utile maintenant !');
        }

        function jouerBotte(carteId) {
            const j = joueurs[joueurActuel];
            j.bottes.push(carteId);
            // La botte soigne aussi le probl√®me correspondant
            if (carteId === 'as_volant') j.statuts.accident = false;
            if (carteId === 'citerne') j.statuts.panne = false;
            if (carteId === 'increvable') j.statuts.crevaison = false;
            if (carteId === 'prioritaire') { j.statuts.arrete = false; j.statuts.feu_rouge = false; }
            retirerCarte();
            piocherCarte();
            finDeTour();
        }

        function choisirCible(carteId, def) {
            if (!reglesAttaques) { alert('Les attaques sont d√©sactiv√©es !'); return; }
            const ciblesRow = document.getElementById('cibles-row');
            ciblesRow.innerHTML = '';
            joueurs.forEach((jj, idx) => {
                if (idx === joueurActuel) return;
                const btn = document.createElement('button');
                btn.className = 'cible-btn';
                btn.textContent = jj.nom + ' (' + jj.km + ' km)';
                btn.onclick = () => attaquer(idx, carteId, def);
                ciblesRow.appendChild(btn);
            });
            showScreen('screen-cible');
        }

        function attaquer(cibleIdx, carteId, def) {
            const cible = joueurs[cibleIdx];
            // V√©rifier bottes
            const botteProtege = { accident: 'as_volant', panne: 'citerne', crevaison: 'increvable', feu_rouge: 'prioritaire' };
            if (botteProtege[carteId] && cible.bottes.includes(botteProtege[carteId])) {
                alert(cible.nom + ' a une botte ! L\'attaque est annul√©e.'); showScreen('screen-jeu'); return;
            }
            if (carteId === 'accident') { if (cible.statuts.accident) { alert(cible.nom + ' a d√©j√† un accident !'); showScreen('screen-jeu'); return; } cible.statuts.accident = true; }
            if (carteId === 'panne') { if (cible.statuts.panne) { alert(cible.nom + ' est d√©j√† en panne !'); showScreen('screen-jeu'); return; } cible.statuts.panne = true; }
            if (carteId === 'crevaison') { if (cible.statuts.crevaison) { alert(cible.nom + ' a d√©j√† une crevaison !'); showScreen('screen-jeu'); return; } cible.statuts.crevaison = true; }
            if (carteId === 'feu_rouge') { if (cible.statuts.arrete && !cible.bottes.includes('prioritaire')) { alert(cible.nom + ' est d√©j√† arr√™t√© !'); showScreen('screen-jeu'); return; } cible.statuts.arrete = true; }
            if (carteId === 'limite') { if (!reglesLimite) { alert('Les limites sont d√©sactiv√©es !'); showScreen('screen-jeu'); return; } if (cible.statuts.limite) { alert(cible.nom + ' est d√©j√† limit√© !'); showScreen('screen-jeu'); return; } cible.statuts.limite = true; }
            retirerCarte();
            piocherCarte();
            showScreen('screen-jeu');
            finDeTour();
        }

        function defausserCarte() {
            if (carteSelectionnee === -1) { alert('S√©lectionne une carte √† d√©fausser !'); return; }
            retirerCarte();
            piocherCarte();
            finDeTour();
        }

        function retirerCarte() {
            joueurs[joueurActuel].main.splice(carteSelectionnee, 1);
            carteSelectionnee = -1;
        }

        function piocherCarte() {
            const c = piocher();
            if (c) joueurs[joueurActuel].main.push(c);
        }

        function passerTour() {
            finDeTour();
        }

        function finDeTour() {
            joueurActuel = (joueurActuel + 1) % nbPlayers;
            afficherPassage();
        }

        function finDePartie() {
            const gagnant = joueurs[joueurActuel];
            document.getElementById('fin-gagnant').textContent = 'ü•á ' + gagnant.nom + ' a gagn√© avec ' + gagnant.km + ' km !';
            const scoresDiv = document.getElementById('fin-scores');
            scoresDiv.innerHTML = '';
            const sorted = [...joueurs].sort((a, b) => b.km - a.km);
            sorted.forEach((j, i) => {
                scoresDiv.innerHTML += `<div class="autre-joueur"><span class="autre-nom">${i+1}. ${j.nom}</span><span class="autre-km">${j.km} km</span></div>`;
            });
            showScreen('screen-fin');
        }
    </script>
</body>
</html>
