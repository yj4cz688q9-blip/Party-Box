<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avis - Party Box</title>
    <link rel="icon" type="image/png" href="F1CE1FF7-8FC2-440D-8100-49C689144B20.png">
    <link rel="apple-touch-icon" href="F1CE1FF7-8FC2-440D-8100-49C689144B20.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0d0d0d; color: white; font-family: Arial, sans-serif; text-align: center; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; overflow-y: auto; }
        h1 { font-size: 36px; color: #ffd166; margin-bottom: 5px; margin-top: 20px; }
        .subtitle { font-size: 15px; color: #888; margin-bottom: 30px; }
        .back-btn { background: none; border: none; color: #888; font-size: 16px; margin-top: 20px; cursor: pointer; }
        .start-btn { background-color: #ffd166; color: #0d0d0d; border: none; border-radius: 20px; padding: 16px 30px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; max-width: 340px; }

        /* STATS */
        .stats-box { background-color: #1a1a1a; border: 2px solid #ffd166; border-radius: 20px; padding: 20px; width: 100%; max-width: 340px; margin-bottom: 20px; }
        .note-globale { font-size: 60px; font-weight: bold; color: #ffd166; }
        .etoiles-globales { font-size: 28px; margin: 5px 0; }
        .nb-avis { font-size: 14px; color: #888; }

        /* AVIS CARD */
        .avis-card { background-color: #1a1a1a; border-radius: 16px; padding: 18px 20px; width: 100%; max-width: 340px; margin-bottom: 12px; text-align: left; border: 2px solid #222; }
        .avis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .avis-email { font-size: 14px; color: #888; }
        .avis-etoiles { font-size: 16px; }
        .avis-commentaire { font-size: 15px; color: #ddd; line-height: 1.5; }
        .avis-date { font-size: 12px; color: #555; margin-top: 8px; }

        /* LOADING */
        .loading { font-size: 16px; color: #888; margin: 40px 0; }
        .erreur { font-size: 15px; color: #ff3b3b; margin: 20px 0; }

        /* BARRE NOTE */
        .barre-row { display: flex; align-items: center; gap: 10px; margin: 4px 0; }
        .barre-label { font-size: 13px; color: #888; min-width: 20px; }
        .barre-bg { flex: 1; height: 8px; background-color: #333; border-radius: 4px; overflow: hidden; }
        .barre-fill { height: 100%; background-color: #ffd166; border-radius: 4px; }
        .barre-count { font-size: 13px; color: #888; min-width: 20px; text-align: right; }
    </style>
</head>
<body>
    <h1>‚≠ê Avis</h1>
    <p class="subtitle">Ce que pensent les joueurs de Party Box !</p>

    <div class="stats-box" id="stats-box" style="display:none">
        <div class="note-globale" id="note-globale">0</div>
        <div class="etoiles-globales" id="etoiles-globales">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
        <div class="nb-avis" id="nb-avis">0 avis</div>
        <div style="margin-top:15px" id="barres-notes"></div>
    </div>

    <div class="loading" id="loading">‚è≥ Chargement des avis...</div>
    <div class="erreur" id="erreur" style="display:none">‚ùå Impossible de charger les avis</div>

    <div id="avis-liste" style="width:100%;max-width:340px"></div>

    <button class="start-btn" onclick="window.location.href='index.html'">üè† Retour √† Party Box</button>
    <br>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfsmXkpEBQtWusTaHL-6yg7kNaPoJi2JDOmYLsawNhvt1iLTA/viewform" target="_blank" style="color:#ffd166;font-size:15px;margin-top:10px">‚úèÔ∏è Laisser un avis</a>
    <div style="height:30px"></div>

    <script>
        const SHEET_ID = '1MpjT4UhMuDQtoAaUbTlBltbBjmfGLsNS2S5kUfV2bOE';
        const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        function etoiles(note) {
            const n = Math.round(note);
            return '‚≠ê'.repeat(n) + '‚òÜ'.repeat(5 - n);
        }

        function anonymiserEmail(email) {
            if (!email || email === '') return 'Anonyme';
            const parts = email.split('@');
            if (parts.length < 2) return 'Anonyme';
            const nom = parts[0];
            return nom.substring(0, 2) + '***@' + parts[1];
        }

        function formaterDate(horodateur) {
            try {
                const d = new Date(horodateur);
                return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
            } catch(e) { return ''; }
        }

        async function chargerAvis() {
            try {
                const response = await fetch(URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const rows = json.table.rows;

                if (!rows || rows.length === 0) {
                    document.getElementById('loading').textContent = 'Aucun avis pour le moment üò¢';
                    return;
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats-box').style.display = 'block';

                const avis = rows.map(row => ({
                    horodateur: row.c[0]?.v || '',
                    email: row.c[1]?.v || '',
                    note: parseFloat(row.c[2]?.v) || 0,
                    commentaire: row.c[3]?.v || ''
                })).filter(a => a.note > 0);

                // Stats
                const total = avis.length;
                const moyenne = avis.reduce((s, a) => s + a.note, 0) / total;
                document.getElementById('note-globale').textContent = moyenne.toFixed(1);
                document.getElementById('etoiles-globales').textContent = etoiles(moyenne);
                document.getElementById('nb-avis').textContent = total + ' avis';

                // Barres par note
                const barres = document.getElementById('barres-notes');
                barres.innerHTML = '';
                for (let i = 5; i >= 1; i--) {
                    const count = avis.filter(a => Math.round(a.note) === i).length;
                    const pct = total > 0 ? (count / total * 100) : 0;
                    barres.innerHTML += `
                        <div class="barre-row">
                            <div class="barre-label">${i}‚≠ê</div>
                            <div class="barre-bg"><div class="barre-fill" style="width:${pct}%"></div></div>
                            <div class="barre-count">${count}</div>
                        </div>
                    `;
                }

                // Liste avis (du plus r√©cent au plus ancien)
                const liste = document.getElementById('avis-liste');
                [...avis].reverse().forEach(a => {
                    if (!a.commentaire) return;
                    const card = document.createElement('div');
                    card.className = 'avis-card';
                    card.innerHTML = `
    <div class="avis-header">
        ${a.prenom ? `<div style="font-size:16px;font-weight:bold;color:white">${a.prenom}</div>` : ''}
        <div class="avis-etoiles">${etoiles(a.note)}</div>
    </div>
    ${a.prenom ? `<div style="font-size:12px;color:#888;margin-bottom:8px">${anonymiserEmail(a.email)}</div>` : ''}
    <div class="avis-commentaire">"${a.commentaire}"</div>
    <div class="avis-date">${formaterDate(a.horodateur)}</div>
                    `;
                    liste.appendChild(card);
                });

            } catch(e) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('erreur').style.display = 'block';
                console.error(e);
            }
        }

        chargerAvis();
    </script>
</body>
</html>
